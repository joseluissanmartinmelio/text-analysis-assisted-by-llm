<!DOCTYPE html>
<html lang="es">

{% extends "base.html" %}

{% block title %}batch processing{% endblock %}

{% block content %}
    <h1>Procesamiento por lotes de documentos</h1>
    
    <p>Procesa múltiples documentos desde un directorio especificado. Los resultados se guardan en el directorio de salida designado.</p>
    
    <form id="batch-form" method="post">
        <div>
            <label for="folder_path">Ruta del directorio de entrada:</label>
            <input type="text"
                   id="folder_path" 
                   name="folder_path" 
                   required 
                   placeholder="/path/to/documents">
        </div>
        
        <div>
            <label for="output_dir">Ruta del directorio de salida:</label>
            <input type="text" 
                   id="output_dir" 
                   name="output_dir" 
                   required 
                   placeholder="/path/to/results">
        </div>
        
        <div>
            <label for="file_extension">Formato de archivo:</label>
            <select name="file_extension" id="file_extension" required>
                <option value=".pdf">pdf (.pdf)</option>
                <option value=".docx">documento de Word (.docx)</option>
                <option value=".txt">texto sin formato (.txt)</option>
            </select>
        </div>
        
        <div>
            <label for="prompt_selection">Tipo de análisis:</label>
            <select name="prompt_selection" id="prompt_selection" required>
                {% for prompt in prompts %}
                    <option value="{{ prompt }}">{{ prompt }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="optional-fields">
            <h3>Additional parameters (if required by selected analysis)</h3>
            
            <div>
                <label for="question">Pregunta de investigación (opcional):</label>
                <input type="text" 
                       id="question" 
                       name="question" 
                       placeholder="specific research question">
            </div>
            
            <div>
                <label for="theme">Foco temático (opcional):</label>
                <input type="text" 
                       id="theme" 
                       name="theme" 
                       placeholder="thematic area of interest">
            </div>
            
            <div>
                <label for="keyword">Palabras clave (opcional):</label>
                <input type="text" 
                       id="keyword" 
                       name="keyword" 
                       placeholder="specific term or concept">
            </div>
        </div>
        
        <div>
            <label>Modelo de procesamiento:</label>
            <div class="ai-model-buttons">
                <button type="button" 
                        class="model-btn" 
                        data-model="claude" 
                        onclick="selectModel('claude')">
                    claude 4
                </button>
                <button type="button" 
                        class="model-btn selected" 
                        data-model="deepseek" 
                        onclick="selectModel('deepseek')">
                    deepseek r1
                </button>
                <button type="button" 
                        class="model-btn" 
                        data-model="openai_o3" 
                        onclick="selectModel('openai_o3')">
                    openai o3
                </button>
                <button type="button" 
                        class="model-btn" 
                        data-model="openai_o4_mini" 
                        onclick="selectModel('openai_o4_mini')">
                    openai o4 mini
                </button>
            </div>
            <input type="hidden" 
                   id="selected_model" 
                   name="selected_model" 
                   value="deepseek" 
                   required>
        </div>
        
        <button id="submit-button" type="submit">Comienzo del proceso por lotes</button>
        
        <div id="loader">
            iniciando el proceso por lotes... esto puede tardar varios minutos.
        </div>
    </form>
    
    <!-- Sección para unificar markdowns -->
    <div id="unify-section" style="margin-top: 2em; padding-top: 2em; border-top: 1px solid var(--border-color);">
        <h2>Consolidar resultados del análisis</h2>
        <p>Después de completar el procesamiento por lotes, puedes consolidar todos los archivos markdown generados en un solo documento y, opcionalmente, generar un PDF.</p>

        <div>
            <label for="unify_output_dir">Directorio de salida (donde se encuentran los archivos markdown):</label>
            <input type="text" 
                   id="unify_output_dir" 
                   name="unify_output_dir" 
                   placeholder="/path/to/results">
        </div>
        
        <button id="unify-button" type="button" onclick="unifyMarkdowns()">
            Consolidar archivos markdown y generar pdf
        </button>
        
        <div id="unify-loader" style="display: none;">
            Consolidando archivos markdown...
        </div>
        
        <div id="unify-result" style="display: none; margin-top: 1em;"></div>
    </div>
    
    <style>
        .optional-fields {
            background-color: #f9f9f9;
            padding: 1.5em;
            border-radius: 2px;
            border: 1px solid var(--border-color);
            margin: 1.5em 0;
        }
        
        .optional-fields h3 {
            margin-top: 0;
            color: var(--secondary-color);
            font-size: 1em;
            margin-bottom: 1em;
            font-weight: 400;
        }
        
        .ai-model-buttons {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .model-btn {
            padding: 8px 16px;
            background-color: #f5f5f5;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
            border-radius: 2px;
            font-family: var(--font-family);
        }
        
        .model-btn:hover {
            background-color: #e8e8e8;
        }
        
        .model-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        #unify-button {
            padding: 12px 24px;
            font-size: 0.95em;
            font-weight: 400;
            color: white;
            background-color: var(--secondary-color);
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 1em;
        }
        
        #unify-button:hover {
            background-color: #555555;
        }
        
        #unify-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #unify-loader {
            text-align: center;
            padding: 12px;
            font-size: 0.9em;
            font-weight: 400;
            color: var(--secondary-color);
            background-color: #f5f5f5;
            border-radius: 2px;
            border: 1px solid var(--border-color);
            margin-top: 1em;
        }
        
        #unify-result {
            padding: 12px;
            border-radius: 2px;
            border: 1px solid var(--border-color);
        }
        
        .success-result {
            background-color: #f0f4f0;
            color: #2d5a2d;
            border-color: #b8d4b8;
        }
        
        .error-result {
            background-color: #f4f0f0;
            color: #5a2d2d;
            border-color: #d4b8b8;
        }
    </style>
    
    <script>
        function selectModel(model) {
            document.getElementById('selected_model').value = model;
            
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelector(`[data-model="${model}"]`).classList.add('selected');
        }
        
        document.getElementById('batch-form').addEventListener('submit', function(e) {
            const selectedModel = document.getElementById('selected_model').value;
            
            if (!selectedModel) {
                e.preventDefault();
                alert('por favor selecciona un modelo de procesamiento antes de iniciar el proceso por lotes.');
                return;
            }
            
            // Mostrar la sección de unificación después de enviar el formulario
            // setTimeout(function() {
            //     document.getElementById('unify-section').style.display = 'block';
            //     // Auto-llenar el directorio de salida si está disponible
            //     const outputDir = document.getElementById('output_dir').value;
            //     if (outputDir) {
            //         document.getElementById('unify_output_dir').value = outputDir;
            //     }
            // }, 1000);
        });
        
        async function unifyMarkdowns() {
            const outputDir = document.getElementById('unify_output_dir').value.trim();
            
            if (!outputDir) {
                alert('Por favor especifica el directorio de salida donde se encuentran los archivos markdown.');
                return;
            }
            
            const unifyButton = document.getElementById('unify-button');
            const unifyLoader = document.getElementById('unify-loader');
            const unifyResult = document.getElementById('unify-result');
            
            // Mostrar loader y deshabilitar botón
            unifyButton.disabled = true;
            unifyLoader.style.display = 'block';
            unifyResult.style.display = 'none';
            
            try {
                const response = await fetch('/unify-markdowns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        output_dir: outputDir
                    })
                });
                
                const result = await response.json();
                
                // Ocultar loader
                unifyLoader.style.display = 'none';
                unifyResult.style.display = 'block';
                
                if (result.success) {
                    unifyResult.className = 'success-result';
                    let message = `<strong>Finalizado</strong><br>${result.message}<br>`;
                    message += `<br><strong>Archivo consolidado:</strong> ${result.markdown_file}`;
                    if (result.pdf_file) {
                        message += `<br><strong>Archivo PDF:</strong> ${result.pdf_file}`;
                    }
                    unifyResult.innerHTML = message;
                } else {
                    unifyResult.className = 'error-result';
                    unifyResult.innerHTML = `<strong>Error:</strong> ${result.message}`;
                }
                
            } catch (error) {
                // Ocultar loader
                unifyLoader.style.display = 'none';
                unifyResult.style.display = 'block';
                unifyResult.className = 'error-result';
                unifyResult.innerHTML = `<strong>Error:</strong> Failed to communicate with server. ${error.message}`;
            } finally {
                // Rehabilitar botón
                unifyButton.disabled = false;
            }
        }
    </script>
{% endblock %}